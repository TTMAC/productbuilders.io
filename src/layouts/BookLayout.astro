---
import BaseLayout from './BaseLayout.astro';
import ProgressBar from '@components/ProgressBar.astro';
import SocialShare from '@components/SocialShare.astro';
import NewsletterSignup from '@components/NewsletterSignup.astro';
import RatingStars from '@components/RatingStars.astro';
import BookCard from '@components/BookCard.astro';
import { getDisciplineLabel, getDisciplineColor, calculateReadingTime, getWordCount, filterDrafts, getRelatedBooks } from '@/utils';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  book: CollectionEntry<'books'>;
}

const { book } = Astro.props;
const {
  title,
  bookAuthor,
  discipline,
  level,
  rating,
  publicationYear,
  crossFunctionalValue,
  keyTakeaways,
  whoShouldRead,
  affiliateLink,
} = book.data;

const { Content } = await book.render();

// Calculate reading time
const readingTime = calculateReadingTime(getWordCount(book.body));

// Get related books
const allBooks = await getCollection('books');
const publishedBooks = filterDrafts(allBooks);
const relatedBooks = getRelatedBooks(book, publishedBooks, 3);
---

<BaseLayout title={title} description={whoShouldRead}>
  <ProgressBar />
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-8">
      <!-- Discipline badge, level badge, and metadata -->
      <div class="flex items-center gap-3 mb-4 flex-wrap">
        <span class={`badge-${getDisciplineColor(discipline)}`}>
          {getDisciplineLabel(discipline)}
        </span>
        <span class="badge-level">{level}</span>
        <span class="text-gray-500 text-sm">{publicationYear}</span>
        <span class="text-gray-500 text-sm">{readingTime} min read</span>
      </div>

      <!-- Title and author -->
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 leading-tight">
        {title}
      </h1>
      <p class="text-xl text-gray-600 mb-4">By {bookAuthor}</p>

      <!-- Rating -->
      <div class="mb-6">
        <RatingStars rating={rating} size="lg" />
      </div>

      <!-- Cross-functional value callout -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
        <p class="text-sm font-semibold text-blue-900 mb-1">Cross-Functional Value</p>
        <p class="text-blue-800">{crossFunctionalValue}</p>
      </div>
    </header>

    <!-- Book review content -->
    <div class="prose-custom">
      <Content />
    </div>

    <!-- Key takeaways -->
    <div class="mt-8 bg-gray-50 rounded-lg p-6">
      <h3 class="text-xl font-bold mb-4">Key Takeaways</h3>
      <ul class="space-y-2">
        {keyTakeaways.map((takeaway) => (
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>{takeaway}</span>
          </li>
        ))}
      </ul>
    </div>

    <!-- Who should read -->
    <div class="mt-8 border-t pt-6">
      <h4 class="font-semibold mb-2">Who Should Read This</h4>
      <p class="text-gray-700">{whoShouldRead}</p>
    </div>

    <!-- Affiliate link -->
    {affiliateLink && (
      <div class="mt-6">
        <a
          href={affiliateLink}
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-primary"
        >
          Purchase on Amazon &rarr;
        </a>
      </div>
    )}

    <!-- Article footer -->
    <footer class="mt-12 pt-8 border-t border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <a
          href="/books"
          class="text-blue-600 hover:text-blue-800 font-medium transition-colors"
        >
          &larr; Back to book reviews
        </a>

        <SocialShare title={title} url={Astro.url.href} />
      </div>
    </footer>

    <!-- Related books -->
    {relatedBooks.length > 0 && (
      <section class="mt-16 pt-8 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Related Book Reviews</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {relatedBooks.map((relatedBook) => (
            <BookCard book={relatedBook} />
          ))}
        </div>
      </section>
    )}
  </article>

  <!-- Newsletter CTA -->
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <NewsletterSignup />
  </section>
</BaseLayout>

---
// Search component using Pagefind client-side search
// Per UX Spec - icon click expands input, 300ms debounce, max 5 results, keyboard navigation
---

<div class="search-container relative">
  <button
    type="button"
    aria-label="Open search"
    aria-expanded="false"
    class="search-toggle p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
  </button>

  <div
    class="search-panel hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
    role="dialog"
    aria-label="Search"
  >
    <div class="relative">
      <svg class="absolute left-3 top-3.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        type="search"
        placeholder="Search articles..."
        autocomplete="off"
        class="search-input w-full pl-10 pr-4 py-3 rounded-t-lg border-b border-gray-200 focus:outline-none text-sm"
        aria-label="Search content"
      />
    </div>

    <div
      class="search-results max-h-80 overflow-y-auto"
      role="listbox"
      aria-label="Search results"
    >
      <div class="search-empty hidden px-4 py-6 text-center text-sm text-gray-500">
        No results found
      </div>
    </div>

    <a
      href="/search"
      class="search-all-link hidden block px-4 py-2.5 text-sm text-blue-600 hover:bg-gray-50 text-center border-t border-gray-200 font-medium"
    >
      See all results
    </a>
  </div>
</div>

<script is:inline>
  (function() {
    var scriptEl = document.currentScript;
    var container = scriptEl.previousElementSibling;
    if (!container || !container.classList.contains('search-container')) return;

    var pagefind = null;
    var debounceTimer;

    var toggle = container.querySelector('.search-toggle');
    var panel = container.querySelector('.search-panel');
    var input = container.querySelector('.search-input');
    var results = container.querySelector('.search-results');
    var empty = container.querySelector('.search-empty');
    var allLink = container.querySelector('.search-all-link');
    var activeIndex = -1;

    async function initPagefind() {
      if (pagefind) return;
      try {
        pagefind = await import('/pagefind/pagefind.js');
      } catch(e) {
        // Pagefind not available (e.g., dev mode without build)
      }
    }

    function openSearch() {
      if (panel) panel.classList.remove('hidden');
      if (toggle) toggle.setAttribute('aria-expanded', 'true');
      if (input) input.focus();
      initPagefind();
    }

    function closeSearch() {
      if (panel) panel.classList.add('hidden');
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
      activeIndex = -1;
    }

    function getResultItems() {
      return results ? results.querySelectorAll('a[role="option"]') : [];
    }

    function setActiveItem(index) {
      var items = getResultItems();
      items.forEach(function(item) { item.classList.remove('bg-gray-100'); });
      if (index >= 0 && index < items.length) {
        items[index].classList.add('bg-gray-100');
        items[index].scrollIntoView({ block: 'nearest' });
      }
      activeIndex = index;
    }

    async function performSearch(query) {
      if (!pagefind || !results || !empty || !allLink) return;

      if (query.length < 2) {
        results.querySelectorAll('a[role="option"]').forEach(function(el) { el.remove(); });
        empty.classList.add('hidden');
        allLink.classList.add('hidden');
        return;
      }

      var search = await pagefind.search(query);
      var top5 = search.results.slice(0, 5);
      var data = await Promise.all(top5.map(function(r) { return r.data(); }));

      results.querySelectorAll('a[role="option"]').forEach(function(el) { el.remove(); });
      activeIndex = -1;

      if (data.length === 0) {
        empty.classList.remove('hidden');
        allLink.classList.add('hidden');
        return;
      }

      empty.classList.add('hidden');

      data.forEach(function(item) {
        var link = document.createElement('a');
        link.href = item.url;
        link.setAttribute('role', 'option');
        link.className = 'block px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0';
        link.innerHTML =
          '<div class="text-sm font-medium text-gray-900 truncate">' + (item.meta && item.meta.title ? item.meta.title : 'Untitled') + '</div>' +
          '<div class="text-xs text-gray-500 mt-1 line-clamp-2">' + (item.excerpt || '') + '</div>';
        results.insertBefore(link, empty);
      });

      if (search.results.length > 5) {
        allLink.href = '/search?q=' + encodeURIComponent(query);
        allLink.classList.remove('hidden');
      } else {
        allLink.classList.add('hidden');
      }
    }

    if (toggle) {
      toggle.addEventListener('click', function() {
        if (panel && panel.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      });
    }

    if (input) {
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          performSearch(input.value.trim());
        }, 300);
      });

      input.addEventListener('keydown', function(e) {
        var items = getResultItems();
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          setActiveItem(Math.min(activeIndex + 1, items.length - 1));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          setActiveItem(Math.max(activeIndex - 1, -1));
        } else if (e.key === 'Enter' && activeIndex >= 0 && items[activeIndex]) {
          e.preventDefault();
          items[activeIndex].click();
        } else if (e.key === 'Escape') {
          closeSearch();
          if (toggle) toggle.focus();
        }
      });
    }

    document.addEventListener('click', function(e) {
      if (!container.contains(e.target)) {
        closeSearch();
      }
    });
  })();
</script>

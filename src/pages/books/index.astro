---
import BaseLayout from '@layouts/BaseLayout.astro';
import DisciplineFilter from '@components/DisciplineFilter.astro';
import LevelFilter from '@components/LevelFilter.astro';
import BookGrid from '@components/BookGrid.astro';
import { getCollection } from 'astro:content';
import { filterDrafts, filterByDiscipline, filterByLevel } from '@/utils/content';

// Get filter params
const discipline = Astro.url.searchParams.get('discipline') || undefined;
const level = Astro.url.searchParams.get('level') || undefined;

// Fetch, filter, and sort books
const allBooks = await getCollection('books');
const publishedBooks = filterDrafts(allBooks);
const filteredByDiscipline = filterByDiscipline(publishedBooks, discipline);
const filteredBooks = filterByLevel(filteredByDiscipline, level);

// Sort by rating descending, then title alphabetically as tiebreaker
const sortedBooks = [...filteredBooks].sort((a, b) => {
  if (b.data.rating !== a.data.rating) return b.data.rating - a.data.rating;
  return a.data.title.localeCompare(b.data.title);
});

const hasActiveFilters = discipline || level;
---

<BaseLayout
  title="Book Reviews"
  description="Curated book reviews for product managers, designers, and engineers"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Book Reviews</h1>
    <p class="text-xl text-gray-600 mb-8">
      Curated book recommendations for product builders
    </p>

    <!-- Discipline filter -->
    <DisciplineFilter
      currentDiscipline={discipline}
      basePath="/books"
      preserveParams={level ? { level } : {}}
    />

    <!-- Level filter -->
    <LevelFilter currentLevel={level} basePath="/books" />

    <!-- Book count -->
    <p class="text-sm text-gray-500 mb-6">
      {sortedBooks.length} book review{sortedBooks.length !== 1 ? 's' : ''}
    </p>

    <!-- Books grid -->
    <BookGrid books={sortedBooks} />

    <!-- Empty state with reset -->
    {
      sortedBooks.length === 0 && hasActiveFilters && (
        <div class="text-center py-4">
          <a href="/books" class="text-blue-600 hover:text-blue-800 font-medium">
            Reset all filters
          </a>
        </div>
      )
    }
  </div>
</BaseLayout>

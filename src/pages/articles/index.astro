---
import BaseLayout from '@layouts/BaseLayout.astro';
import ArticleCard from '@components/ArticleCard.astro';
import { getCollection } from 'astro:content';
import { filterDrafts } from '@/utils/content';
import { sortByDate } from '@/utils/date';

// Fetch all published articles, sorted by date
const allArticles = await getCollection('articles');
const publishedArticles = filterDrafts(allArticles);
const sortedArticles = sortByDate(publishedArticles);

const disciplines = [
  { value: '', label: 'All Disciplines' },
  { value: 'PM', label: 'Product Management' },
  { value: 'Design', label: 'Design' },
  { value: 'Engineering', label: 'Engineering' },
];
---

<BaseLayout
  title="Articles"
  description="Browse our collection of cross-functional product insights for PMs, designers, and engineers"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Articles</h1>
    <p class="text-xl text-gray-600 mb-8">
      Cross-functional insights for building exceptional products
    </p>

    <!-- Discipline filter -->
    <div class="flex flex-wrap gap-2 mb-8" id="discipline-filter">
      {disciplines.map((d) => (
        <a
          href={d.value ? `/articles?discipline=${d.value}` : '/articles'}
          class="filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300"
          data-filter-type="discipline"
          data-filter-value={d.value}
        >
          {d.label}
        </a>
      ))}
    </div>

    <!-- Article count -->
    <p class="text-sm text-gray-500 mb-6" id="article-count">
      {sortedArticles.length} article{sortedArticles.length !== 1 ? 's' : ''}
    </p>

    <!-- Articles grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="articles-grid">
      {sortedArticles.map((article) => <ArticleCard article={article} />)}
    </div>

    <!-- Empty state (hidden by default, shown by JS) -->
    <div class="text-center py-16 hidden" id="empty-state">
      <svg
        class="w-16 h-16 text-gray-400 mx-auto mb-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        />
      </svg>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">No articles found</h3>
      <p class="text-gray-500 mb-4">
        Try selecting a different discipline or check back soon for new content.
      </p>
      <a href="/articles" class="text-blue-600 hover:text-blue-800 font-medium">
        View all articles
      </a>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  (function () {
    var params = new URLSearchParams(window.location.search);
    var discipline = params.get('discipline') || '';

    function updateUI() {
      // Update button active states
      document.querySelectorAll('#discipline-filter .filter-btn').forEach(function (btn) {
        var val = btn.getAttribute('data-filter-value');
        if (val === discipline) {
          btn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white';
        } else {
          btn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
        }
      });

      // Filter cards
      var cards = document.querySelectorAll('.article-card');
      var visibleCount = 0;

      cards.forEach(function (card) {
        if (!discipline) {
          card.style.display = '';
          visibleCount++;
        } else {
          var cardDisciplines = (card.getAttribute('data-disciplines') || '').split(',');
          if (cardDisciplines.indexOf(discipline) !== -1) {
            card.style.display = '';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        }
      });

      // Update count
      var countEl = document.getElementById('article-count');
      if (countEl) {
        countEl.textContent = visibleCount + ' article' + (visibleCount !== 1 ? 's' : '');
      }

      // Show/hide empty state
      var emptyState = document.getElementById('empty-state');
      var gridEl = document.getElementById('articles-grid');
      if (visibleCount === 0 && discipline) {
        if (emptyState) emptyState.classList.remove('hidden');
        if (gridEl) gridEl.classList.add('hidden');
      } else {
        if (emptyState) emptyState.classList.add('hidden');
        if (gridEl) gridEl.classList.remove('hidden');
      }
    }

    // Intercept filter clicks for instant client-side filtering
    document.querySelectorAll('#discipline-filter .filter-btn').forEach(function (btn) {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        discipline = btn.getAttribute('data-filter-value') || '';
        var p = new URLSearchParams();
        if (discipline) p.set('discipline', discipline);
        history.pushState(null, '', p.toString() ? '/articles?' + p.toString() : '/articles');
        updateUI();
      });
    });

    // Handle browser back/forward
    window.addEventListener('popstate', function () {
      var p = new URLSearchParams(window.location.search);
      discipline = p.get('discipline') || '';
      updateUI();
    });

    // Apply initial state from URL
    updateUI();
  })();
</script>

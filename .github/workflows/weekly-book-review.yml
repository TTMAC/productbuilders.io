name: Weekly Book Review

on:
  schedule:
    # Every Friday at 09:00 UTC (11:00 SAST)
    - cron: '0 9 * * 5'
  workflow_dispatch:
    inputs:
      csv_row:
        description: 'CSV row number to generate (leave empty for next scheduled)'
        required: false
        type: number
      dry_run:
        description: 'Dry run â€” show next book without generating'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        if: ${{ !inputs.dry_run }}
        run: npm install -g @anthropic-ai/claude-code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Show next book (dry run)
        if: ${{ inputs.dry_run }}
        run: node scripts/generate-book-review.mjs --dry-run

      - name: Generate book review
        if: ${{ !inputs.dry_run }}
        run: |
          if [ -n "${{ inputs.csv_row }}" ]; then
            node scripts/generate-book-review.mjs --csv-row ${{ inputs.csv_row }}
          else
            node scripts/generate-book-review.mjs
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Show progress
        if: ${{ !inputs.dry_run }}
        run: node scripts/generate-book-review.mjs --status

      - name: Create Pull Request
        if: ${{ !inputs.dry_run }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'content(books): add weekly book review'
          branch: book-review/week-${{ github.run_number }}
          title: 'Book Review: Weekly automated review'
          body: |
            ## Weekly Book Review

            This PR was automatically generated by the weekly book review workflow.

            ### Review Checklist
            - [ ] Review passes Zod schema validation (`npm run build`)
            - [ ] Body has all 10 sections (TL;DR through Bottom Line)
            - [ ] Word count is 1,200-1,500 words
            - [ ] Cross-functional value is substantive
            - [ ] No fabricated quotes
            - [ ] Frontmatter matches book data from CSV
            - [ ] `draft: true` is set

            ### Next Steps
            1. Review the generated content
            2. Run `/quality-check` on the review file
            3. Make any edits needed
            4. Merge when satisfied

            ---
            Generated by [Weekly Book Review Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            content
            book-review
            automated
